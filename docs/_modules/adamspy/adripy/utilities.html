

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>adamspy.adripy.utilities &mdash; adamspy 0.17.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> adamspy
          

          
          </a>

          
            
            
              <div class="version">
                0.17.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">adamspy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>adamspy.adripy.utilities</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for adamspy.adripy.utilities</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;adripy contains functions for manipulating MSC Adams Drill files</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">thornpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="k">import</span> <span class="n">TO_PARAMETER_PATTERN</span><span class="p">,</span> <span class="n">TO_LENGTH_PARAM</span><span class="p">,</span> <span class="n">ADRILL_IDS</span><span class="p">,</span> <span class="n">ADRILL_PLUGIN_VAR</span><span class="p">,</span> <span class="n">ACF_FUNNEL_PATTERN</span><span class="p">,</span> <span class="n">ACF_INTEGRATOR_ERROR_PATTERN</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">TMPLT_ENV</span>

<div class="viewcode-block" id="turn_measure_on"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.turn_measure_on">[docs]</a><span class="k">def</span> <span class="nf">turn_measure_on</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">tool_types</span><span class="o">=</span><span class="p">[],</span> <span class="n">tool_numbers</span><span class="o">=</span><span class="p">[],</span> <span class="n">tool_names</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Modify a string file to turn measure on for teh designated tools.  Tools may be designated by type, number (stack order), or name.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Path to an MSC Adams Drill string file. Accepts full path or cdb alias.</span>
<span class="sd">    tool_types : list, optional</span>
<span class="sd">        List of tool types as seen in the string file (e.g. pdc_bit, motor, stabilizer)</span>
<span class="sd">    tool_numbers : list, optional</span>
<span class="sd">        List of stack orders corresponding to tools in the string</span>
<span class="sd">    tool_names : list, optional</span>
<span class="sd">        List of tool names</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        number of tools measured</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Convert to full path if cdb alias was used</span>
    <span class="n">string_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str_tmp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">):</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c1"># If this is a measure line that has been marked</span>
            <span class="k">elif</span> <span class="n">mark</span> <span class="ow">and</span> <span class="s1">&#39; measure&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Measure  =  &#39;yes&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">mark</span> <span class="o">=</span> <span class="kc">False</span>
                            
            <span class="c1"># Mark if the tool matches a designated stack order</span>
            <span class="k">elif</span> <span class="s1">&#39; stack_order&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">in</span> <span class="n">tool_numbers</span><span class="p">:</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            
            <span class="c1"># Mark if the tool matches a designated tool type</span>
            <span class="k">elif</span> <span class="s1">&#39; type&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tool_types</span><span class="p">:</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            
            <span class="c1"># Mark if the tool matches a designated tool name</span>
            <span class="k">elif</span> <span class="s1">&#39; name&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tool_names</span><span class="p">:</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">string_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="get_tool_name"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_tool_name">[docs]</a><span class="k">def</span> <span class="nf">get_tool_name</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">tool_type</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_full_path</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the name, filename, stack order, and group name of the `n`th tool of type `tool_type` in `string_file`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Path to an Adams drill string file.  Accepts full path or cdb alias.</span>
<span class="sd">    tool_type : str</span>
<span class="sd">        Tool type as seen in the string file (e.g. pdc_bit, motor, stabilizer)</span>
<span class="sd">    n : int</span>
<span class="sd">        If the string file has multiple tools of type `tool_type` , returns the `n` th tool of that type. (the default is 1)</span>
<span class="sd">    return_full_path : bool</span>
<span class="sd">        If true, returns the full path to the tool file instead of using the Adams Drill database (cdb). (the default is True)</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if a tool of type `tool_type` is not found in `string_file`</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Name of the requested tool</span>
<span class="sd">    str</span>
<span class="sd">        Full filepath the the requested tool&#39;s property file</span>
<span class="sd">    int</span>
<span class="sd">        Stack order of tool</span>
<span class="sd">    str</span>
<span class="sd">        Tool&#39;s group name if it has one</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tool_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tool_type</span> <span class="o">==</span> <span class="s1">&#39;hole&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39; Hole_Property_File  =  &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                    
                    <span class="n">tool_file</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tool_file</span><span class="o">.</span><span class="n">split</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">group_name</span> <span class="o">=</span> <span class="n">tool_name</span>
                    <span class="k">if</span> <span class="n">return_full_path</span><span class="p">:</span>
                        <span class="n">tool_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">tool_file</span><span class="p">)</span>
                    <span class="n">tool_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">stack_order</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39; stack_order&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">stack_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39; name &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">group_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="s1">&#39; property_file&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">tool_file</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tool_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">return_full_path</span><span class="p">:</span>
                        <span class="n">tool_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">tool_file</span><span class="p">)</span>
                    <span class="n">tool_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="s1">&#39; type &#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">tool_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">tool_found</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tool_name</span><span class="p">,</span> <span class="n">tool_file</span><span class="p">,</span> <span class="n">stack_order</span><span class="p">,</span> <span class="n">group_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Tool of type </span><span class="si">{}</span><span class="s1"> not found in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tool_type</span><span class="p">,</span> <span class="n">string_file</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_adrill_cdbs"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_adrill_cdbs">[docs]</a><span class="k">def</span> <span class="nf">get_adrill_cdbs</span><span class="p">(</span><span class="n">adrill_user_cfg</span><span class="p">,</span> <span class="n">adrill_shared_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the names and locatinos of all user defined MSC Adams Drill databases (cdbs)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adrill_user_cfg : str</span>
<span class="sd">        Full path to an Adams Drill user configuration file.  This hould be in the users HOME directory.</span>
<span class="sd">    adrill_shared_cfg : str</span>
<span class="sd">        Full path to an Adams Drill shared configuration file.  This should be in the Adams Drill installation directory.  (the default is None, which means that only user cdbs will be returned.)</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary in which the cdb names are keys and the cdb locations are values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdbs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">adrill_user_cfg</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">):</span>
                <span class="c1"># try:</span>
                <span class="n">cdb_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\t</span><span class="s1"> ]+&#39;</span><span class="p">,</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">cdb_loc</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\t</span><span class="s1"> ]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$HOME&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)))</span>
                <span class="n">cdbs</span><span class="p">[</span><span class="n">cdb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdb_loc</span>
                <span class="c1"># except:</span>
                <span class="c1">#     raise cdbError(&#39;The following line in {} could not be interpreted.\n\n{}&#39;.format(adrill_user_cfg,line))</span>
    <span class="k">if</span> <span class="n">adrill_shared_cfg</span><span class="p">:</span>
        <span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">adrill_shared_cfg</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">adrill_shared_cfg</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;DATABASE&#39;</span><span class="p">):</span>
                    <span class="c1"># try:</span>
                    <span class="n">cdb_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\t</span><span class="s1"> ]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">cdb_loc</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\t</span><span class="s1"> ]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$HOME&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$topdir&#39;</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">))</span>                        
                    <span class="n">cdbs</span><span class="p">[</span><span class="n">cdb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdb_loc</span>
                    <span class="c1"># except:</span>
                        <span class="c1"># raise cdbError(&#39;The following line in {} could not be interpreted.\n\n{}&#39;.format(adrill_shared_cfg,line))</span>
    <span class="k">return</span> <span class="n">cdbs</span></div>

<div class="viewcode-block" id="get_TO_param"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_TO_param">[docs]</a><span class="k">def</span> <span class="nf">get_TO_param</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">requested_parameter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the value of a parameter in a tiem orbit file</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to a tiem orbit file. Accepts full path or cdb alias.</span>
<span class="sd">    requested_parameter : str</span>
<span class="sd">        Name of a parameter in TO_file  </span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str` or :obj:`int` or :obj:`float`</span>
<span class="sd">        The value assigned to TO_param in TO_file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if CDB notation used and Convert</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Initialize a flag indicating that the parameter has not yet</span>
    <span class="c1"># been found</span>
    <span class="n">param_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Read in the tiem orbit file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># For each line in the file, check if we are at a parameter line</span>

        <span class="k">if</span> <span class="n">TO_PARAMETER_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="c1"># If we&#39;re at a parameter line, check if it&#39;s the requested parameter.</span>
            <span class="p">[</span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\\</span><span class="s1">s</span><span class="se">\\</span><span class="s1">n]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">requested_parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="c1"># If we&#39;re at the requested parameter line, check if it&#39;s an adams string or a number        </span>
                
                <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="c1"># If value is an adams string</span>
                    <span class="n">requested_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If value is a number</span>
                    <span class="n">requested_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">numtype</span><span class="o">.</span><span class="n">str_is_int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                
                <span class="c1"># Mark the parameter as found</span>
                <span class="n">param_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    
    <span class="c1"># Raise an error if the parameter isn&#39;t found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">param_found</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not contain the parameter </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">requested_parameter</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">requested_value</span></div>

<div class="viewcode-block" id="has_tool"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.has_tool">[docs]</a><span class="k">def</span> <span class="nf">has_tool</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">tool_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns true if string_file has at least one tool of type tool_type</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>
<span class="sd">    tool_type : str</span>
<span class="sd">        Adams Drill tool type</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if string_file contains at least one tool of type tool_type</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tool_type_found</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Convert to full filepath if cdb alias used</span>
    <span class="n">string_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39; Type  =  &#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">tool_type</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">tool_type_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">tool_type_found</span></div>

<div class="viewcode-block" id="fullNotation_to_cdbNotation"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.fullNotation_to_cdbNotation">[docs]</a><span class="k">def</span> <span class="nf">fullNotation_to_cdbNotation</span><span class="p">(</span><span class="n">string_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces all references in a string file that use full path notation to use CDB notation</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of replacements made</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize a variable to count the number of replacements</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str_tmp</span><span class="p">:</span>
        <span class="c1"># Open the string file</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid_str</span><span class="p">:</span>
            <span class="c1"># For each line in the file</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Property_File *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>       
                <span class="c1"># If this is a propery file line that doesn&#39;t use cdb_notation, get the property file</span>
                <span class="n">property_file</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="c1"># Rewrite the line replacing the property file with the cdb path property file</span>
                <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39; Property_File  =  </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_cdb_path</span><span class="p">(</span><span class="n">property_file</span><span class="p">))</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>

                <span class="c1"># Increment the number of replacements</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If this is not a property file line that doesn&#39;t use cdb_notation, write the line unchanged</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">string_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="cdbNotation_to_fullNotation"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.cdbNotation_to_fullNotation">[docs]</a><span class="k">def</span> <span class="nf">cdbNotation_to_fullNotation</span><span class="p">(</span><span class="n">string_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replaces all references in a string file that use CDB notation to use full path notation</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of replacements made</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="c1"># Convert to full filepath if cdb alias used</span>
    <span class="n">string_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_str_tmp</span><span class="p">:</span>
        <span class="c1"># Open the string file</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid_str</span><span class="p">:</span>
            <span class="c1"># For each line in the file</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Property_File *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># If this is a propery file line that uses cdb_notation, get the property file</span>
                <span class="n">property_file</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="c1"># Rewrite the line replacing the property file with the cdb path property file</span>
                <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39; Property_File  =  </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_full_path</span><span class="p">(</span><span class="n">property_file</span><span class="p">))</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
                
                <span class="c1"># Increment the number of replacements</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If this is not a property file line that uses cdb_notation, write the line unchanged</span>
                <span class="n">fid_str_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">string_file</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="get_cdb_path"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_cdb_path">[docs]</a><span class="k">def</span> <span class="nf">get_cdb_path</span><span class="p">(</span><span class="n">full_filepath</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;Given the full path to a file located in a cdb, get_cdb_path returns the path to a file with the cdb path replaced by the cdb alias.  `full_filepath` will be returned if no cdb is found in the path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_filepath : str</span>
<span class="sd">        Full file path to a file in a cdb</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to a file with the cdb path replaced by the cdb alias.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the filepath</span>
    <span class="n">full_filepath</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">full_filepath</span><span class="p">)</span>

    <span class="c1"># Find a string that looks like a database alias</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^&lt;.+&gt;&#39;</span><span class="p">,</span> <span class="n">full_filepath</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Return the given filepath if filepath looks like a cdb filepath</span>
        <span class="n">cdb_filepath</span> <span class="o">=</span> <span class="n">full_filepath</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If full_filepath does not use cdb notation, get a dictionary of the known cdbs</span>
        <span class="n">cdbs</span> <span class="o">=</span> <span class="n">get_adrill_cdbs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_USER_CFG&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_SHARED_CFG&#39;</span><span class="p">])</span>

        <span class="n">cdb_loc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># For each cdb in the cfg files</span>

            <span class="k">if</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">full_filepath</span><span class="p">:</span>
                <span class="c1"># If the cdb location is in the filepath, </span>
                <span class="n">cdb_loc</span> <span class="o">=</span> <span class="n">loc</span>
                <span class="n">cdb_name</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">break</span>
                
        <span class="c1"># Set the cdb_filepath by replacing the cdb path with the alias in full_filepath, if no cdb path was found, set it equal to the full filepath</span>
        <span class="n">cdb_filepath</span> <span class="o">=</span> <span class="n">full_filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cdb_loc</span><span class="p">,</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdb_name</span><span class="p">))</span> <span class="k">if</span> <span class="n">cdb_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">full_filepath</span>
        
    <span class="k">return</span> <span class="n">cdb_filepath</span></div>

<div class="viewcode-block" id="get_full_path"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_full_path">[docs]</a><span class="k">def</span> <span class="nf">get_full_path</span><span class="p">(</span><span class="n">cdb_filepath</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;Given the cdb path to a file located in a cdb, returns the path to a file with the cdb alias replaced by the cdb location.  If `cdb_filepath` does not use cdb notation, returns the full filepath (convertes a relative filepath to a full filepath).</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    `cdb_filepath` is **not** case sensitive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cdb_filepath : str</span>
<span class="sd">        Full file path to a file in a cdb.</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to a file with the cdb path replaced by the cdb alias.</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Find a string that looks like a database alias</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^&lt;.+&gt;&#39;</span><span class="p">,</span> <span class="n">cdb_filepath</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Return the given filepath if filepath looks like a full filepath</span>
        <span class="n">full_filepath</span> <span class="o">=</span> <span class="n">cdb_filepath</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If cdb_filepath uses cdb notation, pull the database name out of the group</span>
        <span class="n">cdb_in_filepath</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Get a dictionary of the known cdbs</span>
        <span class="n">cdbs</span> <span class="o">=</span> <span class="n">get_adrill_cdbs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_USER_CFG&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_SHARED_CFG&#39;</span><span class="p">])</span>
        
        <span class="c1"># Get the location of cdb_in_filepath</span>
        <span class="n">cdb_loc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># For each cdb in the cfg files</span>

            <span class="k">if</span> <span class="n">cdb_in_filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>                
                <span class="c1"># If the cdb name from the cfg files equals the cdb name found in the filepath, store that cdbs location                </span>
                <span class="n">cdb_loc</span> <span class="o">=</span> <span class="n">loc</span>
                <span class="k">break</span>

        <span class="c1"># Raise an error if cdb_in_filepath is not in the cdbs dictionary</span>
        <span class="k">if</span> <span class="n">cdb_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not in </span><span class="si">{}</span><span class="s1"> OR </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdb_in_filepath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_USER_CFG&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_SHARED_CFG&#39;</span><span class="p">]))</span>
        
        <span class="n">full_filepath</span> <span class="o">=</span> <span class="n">cdb_filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cdb_loc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">full_filepath</span></div>

<div class="viewcode-block" id="get_cdb_location"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_cdb_location">[docs]</a><span class="k">def</span> <span class="nf">get_cdb_location</span><span class="p">(</span><span class="n">cdb_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the location of cdb &#39;cdb_name&#39;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cdb_name : str</span>
<span class="sd">        Alias of a cdb</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Location of cdb</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cdbs</span> <span class="o">=</span> <span class="n">get_adrill_cdbs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_USER_CFG&#39;</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_SHARED_CFG&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cdbs</span><span class="p">[</span><span class="n">cdb_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="replace_tool"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.replace_tool">[docs]</a><span class="k">def</span> <span class="nf">replace_tool</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">old_tool_file</span><span class="p">,</span> <span class="n">new_tool_file</span><span class="p">,</span> <span class="n">old_tool_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">new_tool_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Swaps old_tool_file for new_tool_file in string_file.  Also replaces the tools Name field.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Path to an Adams Drill string file.  Accepts full path or cdb aliases.</span>
<span class="sd">    old_tool_file : str</span>
<span class="sd">        Path to an Adams Drill tool property file that exists in string_file. Accepts full path or cdb aliases.</span>
<span class="sd">    new_tool_file : str</span>
<span class="sd">        Path to an Adams Drill tool property file to replace old_tool_file.   Accepts full path or cdb aliases.</span>
<span class="sd">    N : int</span>
<span class="sd">        Number of replacements to make. Default is 0 which will replace all instances.</span>
<span class="sd">    old_tool_name : str</span>
<span class="sd">        Name of the tool to replace. Default is the filename.</span>
<span class="sd">    new_tool_name : str</span>
<span class="sd">        Name of the new tool.  Default is the filename.</span>
<span class="sd">                  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of replacements that were made</span>

<span class="sd">    &quot;&quot;&quot;</span>        
    <span class="c1"># Convert tool filenames to full paths</span>
    <span class="n">string_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">old_tool_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">old_tool_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">old_tool_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">new_tool_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">new_tool_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Open the original string file for reading and a new string file for writing</span>
    <span class="n">fid_old</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fid_new</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1"># Initiate the number of replacements made</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># If the tool is a hole</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">old_tool_file</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;.hol&#39;</span><span class="p">:</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid_old</span><span class="p">:</span>
            <span class="c1"># Loop through the string file to find the hole property file line</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Hole_Property_File *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="c1"># If at a hole property file line, convert new_tool_file to cdb or full notation depending on what&#39;s already in the file</span>
                <span class="n">new_tool_file</span> <span class="o">=</span> <span class="n">get_cdb_path</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">else</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">)</span>

                <span class="c1"># Write the modified line</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Hole_Property_File  =  &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">))</span>
                
                <span class="c1"># Increment the number of replacements made</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If not at a hole property file line, write the line unchanged</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>    
    
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If the tool is not a hole, initialize a flag indicating a replacement should be made on the next line</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid_old</span><span class="p">:</span>
            <span class="c1"># Loop through the string file to find and replace the corresponding tool block</span>

            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Type *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Stack_Order *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">stack_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Name *= *</span><span class="se">\&#39;</span><span class="si">{}</span><span class="s1">.*</span><span class="se">\&#39;</span><span class="s1">.*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_tool_name</span><span class="p">),</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span><span class="o">&lt;</span><span class="n">N</span> <span class="ow">or</span> <span class="n">N</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="c1"># If this is the tool name line for the tool to replace</span>
                
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Name *= *</span><span class="se">\&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:02d}</span><span class="se">\&#39;</span><span class="s1">.*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_tool_name</span><span class="p">,</span> <span class="n">stack_order</span><span class="p">),</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                    <span class="c1"># If the tool name has a stack order appended</span>
                    <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Name  =  &#39;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{:02d}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_tool_name</span><span class="p">,</span> <span class="n">stack_order</span><span class="p">))</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If the tool name does not have a stack order appended</span>
                    <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Name  =  &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_tool_name</span><span class="p">))</span>

                <span class="c1"># Indicate that a replacement should be made on the next property file line</span>
                <span class="n">replace</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Property_File *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">replace</span><span class="p">:</span>
                <span class="c1"># If at a property file line, convert new_tool_file to cdb or full notation depending on what&#39;s already in the file    </span>
                <span class="n">new_tool_file</span> <span class="o">=</span> <span class="n">get_cdb_path</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">else</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">)</span>
                
                <span class="c1"># Write the modified line</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; Property_File  =  &#39;</span><span class="si">{}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_tool_file</span><span class="p">))</span>                
                
                <span class="c1"># Indicate that a replacement should not be made on the next property file line</span>
                <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Increment the number of replacements made</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If not at a property file line, write the line unchanged</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># Close the string files, delete the original one, and rename the new one</span>
    <span class="n">fid_old</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">fid_new</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">string_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.str&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">string_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="get_string_length"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_string_length">[docs]</a><span class="k">def</span> <span class="nf">get_string_length</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">bha_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the total length of the drill string defined in `string_file`</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>
<span class="sd">    bha_only : bool</span>
<span class="sd">        If True, ignores the length of top most physical string and equivalent upper string</span>
<span class="sd">                      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Cumulative length of the string</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Convert to full filepath if cdb alias used</span>
    <span class="n">string_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">)</span>

    <span class="n">tool_lengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="c1"># Open the string file</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="c1"># For each line in the string file</span>
            
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *Property_File *= *.*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>            
                <span class="c1"># If at a property file line, get the property file</span>
                <span class="n">tool_file</span> <span class="o">=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>                

                <span class="c1"># Open the tool file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tool_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_tool</span><span class="p">:</span>
                    <span class="n">file_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="k">for</span> <span class="n">tool_line</span> <span class="ow">in</span> <span class="n">fid_tool</span><span class="p">:</span>
                        <span class="c1"># For each line in the tool file</span>
                        
                        <span class="k">if</span> <span class="n">file_type</span> <span class="ow">and</span> <span class="s1">&#39;top_drive&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">tool_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">TO_LENGTH_PARAM</span><span class="p">[</span><span class="n">file_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">):</span>
                            <span class="c1"># If this parameter is the length parameter, get the tool length</span>
                            <span class="n">tool_length</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tool_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">tool_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_length</span><span class="p">)</span>
                            <span class="k">break</span>
                        
                        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39; *File_Type *= *.*&#39;</span><span class="p">,</span> <span class="n">tool_line</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                            <span class="n">file_type</span> <span class="o">=</span> <span class="n">tool_line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="s1">&#39; number_of_joints&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tool_lengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_lengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    
    <span class="c1"># Sum the tool lengths to get the string length</span>
    <span class="n">string_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tool_lengths</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="n">bha_only</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tool_lengths</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">string_length</span></div>

<div class="viewcode-block" id="get_bha_length"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_bha_length">[docs]</a><span class="k">def</span> <span class="nf">get_bha_length</span><span class="p">(</span><span class="n">string_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the total length of the drill string defined in string_file NOT including the equivalent upper string and highest most physical string</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Cumulative length of the string    </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bha_length</span> <span class="o">=</span> <span class="n">get_string_length</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">bha_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bha_length</span></div>

<div class="viewcode-block" id="get_number_of_tools"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_number_of_tools">[docs]</a><span class="k">def</span> <span class="nf">get_number_of_tools</span><span class="p">(</span><span class="n">string_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets the total number of tools in a string.  Tools for which quantitiiy can be defined are only counted once.  The top drive is not included</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string_file : str</span>
<span class="sd">        Full path to an Adams Drill string file</span>
<span class="sd">                      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of tools  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; stack_order &#39;</span><span class="p">):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">num</span></div>
    
<div class="viewcode-block" id="add_cdb_to_cfg"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.add_cdb_to_cfg">[docs]</a><span class="k">def</span> <span class="nf">add_cdb_to_cfg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds cdb of name `name` and path `loc` to `cfg_file`</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of cdb (e.g. example_database)</span>
<span class="sd">    loc : str</span>
<span class="sd">        path to cdb (e.g. C:\\example_database.cdb)</span>
<span class="sd">    cfg_file : str</span>
<span class="sd">        Full filename of an adams drill configuration file</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if a cdb of the given name or path already exists in the given config file</span>
<span class="sd">    PermissionError</span>
<span class="sd">        Raised if the user does not have permissiosn to edit the given config file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
    <span class="n">cdbs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Read config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># Pull cdbs from config file into a dictionary</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">):</span>
            <span class="n">splt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[ </span><span class="se">\t</span><span class="s1">]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cdbs</span><span class="p">[</span><span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Check if cdb name already exists</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already exists in </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">))</span>
    
    <span class="c1"># Check if cdb location already exists</span>
    <span class="k">for</span> <span class="n">cdb_name</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">loc</span> <span class="ow">is</span> <span class="n">cdbs</span><span class="p">[</span><span class="n">cdb_name</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already exists in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">))</span>
    
    <span class="c1"># Add new cdb to cdbs dictionary</span>
    <span class="n">cdbs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span>

    <span class="c1"># Rewrite config file with new cdb</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">cdbs_written</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">):</span>
                    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">cdbs_written</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cdb_name</span><span class="p">,</span> <span class="n">cdb_loc</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;DATABASE   </span><span class="si">{}</span><span class="s1">   </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdb_name</span><span class="p">,</span> <span class="n">cdb_loc</span><span class="p">)</span>
                        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">cdbs_written</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;You do not have permission to edit </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">))</span>    </div>

<div class="viewcode-block" id="remove_cdb_from_cfg"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.remove_cdb_from_cfg">[docs]</a><span class="k">def</span> <span class="nf">remove_cdb_from_cfg</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes cdb of name `name` from `cfg_file`</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of cdb (e.g. example_database)</span>
<span class="sd">    cfg_file : str</span>
<span class="sd">        Full filename of an adams drill configuration file</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if a cdb of the given name or path already exists in the given config file</span>
<span class="sd">    PermissionError</span>
<span class="sd">        Raised if the user does not have permissiosn to edit the given config file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize cdbs dictionary</span>
    <span class="n">cdbs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Read config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># Pull cdbs from config file into a dictionary</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">):</span>
            <span class="n">splt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[ </span><span class="se">\t</span><span class="s1">]+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">cdbs</span><span class="p">[</span><span class="n">splt</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">splt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Check if cdb name exists</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist in </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg_file</span><span class="p">))</span>
    
    <span class="c1"># Remove cdb from cdbs dictionary</span>
    <span class="k">del</span> <span class="n">cdbs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># Rewrite config file with the cdb removed</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">cdbs_written</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">):</span>
                    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">cdbs_written</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cdb_name</span><span class="p">,</span> <span class="n">cdb_loc</span> <span class="ow">in</span> <span class="n">cdbs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;DATABASE   </span><span class="si">{}</span><span class="s1">   </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cdb_name</span><span class="p">,</span> <span class="n">cdb_loc</span><span class="p">)</span>
                        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">cdbs_written</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">PermissionError</span><span class="p">(</span><span class="s1">&#39;You do not have permission to edit </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">))</span>  </div>

<div class="viewcode-block" id="create_cfg_file"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.create_cfg_file">[docs]</a><span class="k">def</span> <span class="nf">create_cfg_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">database_paths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a cfg file with the databases whose paths are given in the database_paths list. Also sets the ADRILL_USER_CONFIG environment variable equal to filename.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Filename for the new configuration file.</span>
<span class="sd">    database_paths : list</span>
<span class="sd">        List of database paths to include in the configuration file. </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a databases dictionary</span>
    <span class="n">databases</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">database_paths</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.cdb&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">databases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">})</span>

    <span class="c1"># Get the cfg template</span>
    <span class="n">cfg_template</span> <span class="o">=</span> <span class="n">TMPLT_ENV</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="s1">&#39;template.cfg&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    
    <span class="c1"># Write the new cfg file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cfg_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">databases</span><span class="o">=</span><span class="n">databases</span><span class="p">))</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADRILL_USER_CFG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="build"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.build">[docs]</a><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="n">solver_settings_file</span><span class="p">,</span> <span class="n">working_directory</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;Builds adm, acf, and cmd files from string, event, and solver settings files.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string : str</span>
<span class="sd">        Filename of a drill string (.str) file.</span>
<span class="sd">    solver_settings : str</span>
<span class="sd">        Filename of a solver settings (.ssf) file.</span>
<span class="sd">    working_directory : str</span>
<span class="sd">        Path to the directory to put the adm, acf, and cmd</span>
<span class="sd">    output_name : str</span>
<span class="sd">        Base name of the adm, acf, and cmd files. (the default is none, which redefines the `ouput_name` to be the same as the &#39;OutputName&#39; parameter in the string file)</span>
<span class="sd">    wait : bool</span>
<span class="sd">        If True, code execution waits until the build process terminates before moving on. (default is True)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Filename of the adams dataset (.adm) file.</span>
<span class="sd">    str</span>
<span class="sd">        Filename of the adams command (.acf) file.</span>
<span class="sd">    str</span>
<span class="sd">        Filename of the adams view command (.cmd) file.</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Set the output name  </span>
    <span class="k">if</span> <span class="n">output_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  
        <span class="n">output_name</span> <span class="o">=</span> <span class="n">get_TO_param</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;OutputName&#39;</span><span class="p">)</span>       
    
    
    <span class="c1"># Set the names of the output files</span>
    <span class="n">adm_file</span> <span class="o">=</span> <span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;.adm&#39;</span>
    
    <span class="n">acf_file</span> <span class="o">=</span> <span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;.acf&#39;</span>
    <span class="n">cmd_file</span> <span class="o">=</span> <span class="n">output_name</span> <span class="o">+</span> <span class="s1">&#39;.cmd&#39;</span>
    
    <span class="c1"># Format the string filename    </span>
    <span class="n">adams_formatted_str_filename</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">get_full_path</span><span class="p">(</span><span class="n">string_file</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    
    <span class="c1"># Set the event filename and solver settings file name (relative paths if in the same directory)    </span>
    <span class="n">event_file</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">get_TO_param</span><span class="p">(</span><span class="n">string_file</span><span class="p">,</span> <span class="s1">&#39;Event_Property_File&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">event_file</span><span class="p">)</span> <span class="o">==</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">working_directory</span><span class="p">):</span>
        <span class="n">evt_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">event_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">evt_name</span> <span class="o">=</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">event_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">solver_settings_file</span><span class="p">)</span> <span class="o">==</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">working_directory</span><span class="p">):</span>
        <span class="n">ssf_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">solver_settings_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ssf_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">solver_settings_file</span><span class="p">)</span>

    <span class="c1"># Create aview script</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;plugin load plugin_name = </span><span class="si">{ADRILL_PLUGIN_VAR}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;ds TOStart string_cfg_file = &quot;</span><span class="si">{adams_formatted_str_filename}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;adrill build acf ssf=&quot;</span><span class="si">{ssf_name}</span><span class="s1">&quot; evt=&quot;</span><span class="si">{evt_name}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;file adams write file=&quot;</span><span class="si">{adm_file}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;simulation script write_acf sim_script_name = &quot;</span><span class="si">{output_name}</span><span class="s1">&quot; file_name = &quot;</span><span class="si">{acf_file}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;file command write entity_name = &quot;</span><span class="si">{output_name}</span><span class="s1">&quot; file_name = &quot;</span><span class="si">{cmd_file}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="c1"># If the working directory doesn&#39;t exit, create it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">working_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>

    <span class="c1"># Create the build.cmd script</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="s1">&#39;build.cmd&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>			
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                                            
    <span class="c1"># Run adams to generate adm, acf, cmd</span>
    <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
    <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; aview ru-s b build.cmd&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ADAMS_LAUNCH_COMMAND&#39;</span><span class="p">]),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">)</span>

    <span class="n">adm_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">adm_file</span><span class="p">)</span>
    <span class="n">acf_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">acf_file</span><span class="p">)</span>
    <span class="n">cmd_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="n">cmd_file</span><span class="p">)</span>

    <span class="c1"># Wait for the process to finish (if requested)</span>
    <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If the process has terminated, stop waiting</span>
                <span class="k">break</span>

            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">adm_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">acf_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmd_file</span><span class="p">):</span>
                <span class="c1"># If the process hasn&#39;t terminated, but the adm file acf file and cmd files all exist</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">break</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If the model is still being built</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
    <span class="k">return</span> <span class="n">adm_file</span><span class="p">,</span> <span class="n">acf_file</span><span class="p">,</span> <span class="n">cmd_file</span></div>

<span class="n">TO_BLOCK_HEADER_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^</span><span class="se">\\</span><span class="s1">[[_0-9a-zA-Z]+</span><span class="se">\\</span><span class="s1">]</span><span class="se">\\</span><span class="s1">s*$&#39;</span><span class="p">)</span> 
<span class="n">TO_SUBBLOCK_HEADER_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^</span><span class="se">\\</span><span class="s1">([_0-9a-zA-Z]+</span><span class="se">\\</span><span class="s1">)</span><span class="se">\\</span><span class="s1">s*$&#39;</span><span class="p">)</span> 
<span class="n">TO_TABLE_HEADER_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^</span><span class="se">\\</span><span class="s1">{(</span><span class="se">\\</span><span class="s1">s*[_0-9a-zA-Z])+</span><span class="se">\\</span><span class="s1">s*</span><span class="se">\\</span><span class="s1">}</span><span class="se">\\</span><span class="s1">s*$&#39;</span><span class="p">)</span>
<span class="n">TO_TABLE_LINE_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^((</span><span class="se">\\</span><span class="s2">s*</span><span class="se">\\</span><span class="s2">&#39;[_0-9a-zA-Z]+</span><span class="se">\\</span><span class="s2">&#39;)+)|((</span><span class="se">\\</span><span class="s2">s*-?[</span><span class="se">\\</span><span class="s2">+-</span><span class="se">\\</span><span class="s2">.eE0-9]+)+)</span><span class="se">\\</span><span class="s2">s*(&lt;- use this format for constant values)?</span><span class="se">\\</span><span class="s2">s$&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="read_TO_file"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.read_TO_file">[docs]</a><span class="k">def</span> <span class="nf">read_TO_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a Tiem Orbit file into a dictionary of parameters</span>
<span class="sd">    </span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    This example prints the value of the `Integrator` parameter from the `DYNAMICS` block of a solver settings file.</span>

<span class="sd">    &gt;&gt;&gt; ssf = read_TO_file(&#39;example.ssf&#39;)</span>
<span class="sd">    &gt;&gt;&gt; integ = ssf[&#39;DYNAMICS&#39;][&#39;Integrator&#39;]</span>
<span class="sd">    &gt;&gt;&gt; print(integ)</span>
<span class="sd">    HHT</span>

<span class="sd">    This example prints `Maxit` from the `FUNNEL` subblock of the `STATICS` block of a solver settings file.</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ssf = adripy.read_TO_file(&#39;example.ssf&#39;)</span>
<span class="sd">    &gt;&gt;&gt; maxit = ssf[&#39;STATICS&#39;][&#39;FUNNEL&#39;][&#39;maxit&#39;]</span>
<span class="sd">    &gt;&gt;&gt; print(maxit)</span>
<span class="sd">    [100, 50, 50, 50]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Filename of the Tiem Orbit file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Nested :obj:`dict` of the blocks, subblocks, and parameters.  </span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TiemOrbitSyntaxError</span>
<span class="sd">        Raised if the Tiem Orbit syntax is not recognized</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">get_full_path</span><span class="p">(</span><span class="n">thornpy</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">convert_path</span><span class="p">(</span><span class="n">filename</span><span class="p">))):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{filename}</span><span class="s1"> does not exist!&#39;</span><span class="p">)</span>
    
    <span class="c1"># Read in the TO file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_full_path</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>    

    <span class="n">current_block</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_subblock</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_table_headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># For each line determine if we are at a new Block, new SubBlock, or Table</span>
        
        <span class="k">if</span> <span class="n">TO_BLOCK_HEADER_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="c1"># if a block is encountered, reset currents  </span>
            <span class="n">current_block</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\\</span><span class="s1">[</span><span class="se">\\</span><span class="s1">]</span><span class="se">\\</span><span class="s1">s</span><span class="se">\\</span><span class="s1">n]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>       
            <span class="n">current_subblock</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">current_table_headers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Create a new parameters dictionary entry</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">elif</span> <span class="n">TO_SUBBLOCK_HEADER_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="c1"># If a subblock is encountered, reset currents</span>
            <span class="n">current_subblock</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\\</span><span class="s1">(</span><span class="se">\\</span><span class="s1">)</span><span class="se">\\</span><span class="s1">s</span><span class="se">\\</span><span class="s1">n]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>       
            <span class="n">current_table_headers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># Create a new parameters dictionary entry</span>
            <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">current_subblock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">elif</span> <span class="n">TO_TABLE_HEADER_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="c1"># If a table is encountered, get the table headers            </span>
            <span class="n">current_table_headers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            
            <span class="c1"># Make a dictionary of empty lists to put the table data in</span>
            <span class="n">current_table_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">header</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">current_table_headers</span><span class="p">}</span>

            <span class="c1"># Add empty table data to parameters dictionary</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">current_table_headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_subblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">current_subblock</span><span class="p">][</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">elif</span> <span class="n">TO_PARAMETER_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>            
            <span class="p">[</span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s*=</span><span class="se">\\</span><span class="s1">s*&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="c1"># Format the value </span>
            <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># If value is an adams string</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If value is a number                </span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">numtype</span><span class="o">.</span><span class="n">str_is_int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Add parameter to parameters dictionary</span>
            <span class="k">if</span> <span class="n">current_subblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">current_subblock</span><span class="p">][</span><span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">parameter</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="n">current_table_headers</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># If already at a table</span>

            <span class="k">if</span> <span class="n">TO_TABLE_LINE_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="c1"># If the current line looks like a table entry</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;- use this format for constant values&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_table_headers</span><span class="p">):</span>
                    <span class="c1"># If the number of values doesn&#39;t match the number of table headers raise an error</span>
                    <span class="k">raise</span> <span class="n">TiemOrbitSyntaxError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Incorrect syntax found while processing a table in the </span><span class="si">{current_block}</span><span class="s1"> block of </span><span class="si">{filename}</span><span class="s1">!&#39;</span><span class="p">)</span>
                
                <span class="c1"># Add the value to the table data dictionary</span>
                <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">current_table_headers</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;&#39;&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="c1"># If value is an adams string</span>
                        <span class="n">current_table_data</span><span class="p">[</span><span class="n">header</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If value is a number</span>
                        <span class="n">current_table_data</span><span class="p">[</span><span class="n">header</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">thornpy</span><span class="o">.</span><span class="n">numtype</span><span class="o">.</span><span class="n">str_is_int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                <span class="c1"># Add table data to parameters dictionary</span>
                <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">current_table_headers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_subblock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">current_subblock</span><span class="p">][</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">current_table_data</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parameters</span><span class="p">[</span><span class="n">current_block</span><span class="p">][</span><span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">current_table_data</span><span class="p">[</span><span class="n">header</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">parameters</span></div>

<div class="viewcode-block" id="isabs"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.isabs">[docs]</a><span class="k">def</span> <span class="nf">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if a filepath is absolute.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This function is derived from :meth:`os.path.isabs`.  The only difference is that it returns `True` if the filepth uses cdb alias names.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to a file.  Can be relateive, absolute, or use cdb aliases. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if path is absolute or uses cdb aliases.</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># If filname is not a string</span>
        <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="n">filename</span> <span class="o">!=</span> <span class="n">get_full_path</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1"># If filename uses cdb alias notation</span>
        <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1"># If filename is an absolute path</span>
        <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If filename is a relative</span>
        <span class="n">is_abs</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">return</span> <span class="n">is_abs</span></div>
            
<div class="viewcode-block" id="add_splines_to_adm"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.add_splines_to_adm">[docs]</a><span class="k">def</span> <span class="nf">add_splines_to_adm</span><span class="p">(</span><span class="n">adm_file</span><span class="p">,</span> <span class="n">splines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds splines inputs to an Adams Drill dataset (.adm) file.</span>
<span class="sd">    </span>
<span class="sd">    Adds a block titled SPLINES above the OUTPUT block of the ADM file.  The SPLINES block contains a SPLINE statement for each of the four drilling parameters.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; time = [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]</span>
<span class="sd">    &gt;&gt;&gt; gpm = [0, 78.125, 250.0, 421.875, 500, 500, 500, 500, 500, 500, 500]</span>
<span class="sd">    &gt;&gt;&gt; rpm = [0, 0, 0, 0, 12, 37, 50, 50, 50, 50, 50]</span>
<span class="sd">    &gt;&gt;&gt; wob = [0, 0, 0, 0, 0, 0, 0, 10, 29, 40, 40]</span>
<span class="sd">    &gt;&gt;&gt; rop = [0, 0, 0, 0, 0, 0, 0, 25, 74, 100, 100]</span>
<span class="sd">    &gt;&gt;&gt; splines = {}</span>
<span class="sd">    &gt;&gt;&gt; splines[&#39;gpm&#39;] = [time, gpm]</span>
<span class="sd">    &gt;&gt;&gt; splines[&#39;rpm&#39;] = [time, rpm]</span>
<span class="sd">    &gt;&gt;&gt; splines[&#39;wob&#39;] = [time, wob]</span>
<span class="sd">    &gt;&gt;&gt; splines[&#39;rop&#39;] = [time, rop]</span>
<span class="sd">    &gt;&gt;&gt; adm_file = &#39;demo.adm&#39;</span>
<span class="sd">    &gt;&gt;&gt; add_splines_to_adm(adm_file, splines)    </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adm_file : str</span>
<span class="sd">        Filename of Adams Drill dataset (.adm) file</span>
<span class="sd">    splines : dict</span>
<span class="sd">        Dictionary containing the spline data for the four drilling parameters.  See Example for dictionary makeup.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a block of code to add to the adm file</span>
    <span class="n">code_block</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ADRILL_IDS</span><span class="p">:</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;!                          adams_view_name=&#39;</span><span class="si">{}</span><span class="s2">_Spline&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;SPLINE/</span><span class="si">{:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ADRILL_IDS</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s1">&#39;spline&#39;</span><span class="p">])</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;, LINEAR_EXTRAPOLATE</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;, X=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">splines</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        
        <span class="n">val_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">splines</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
            <span class="n">val_string</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{:1.2f}</span><span class="s1">,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val_string</span> <span class="o">=</span> <span class="n">val_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;, Y=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_string</span><span class="p">)</span>
        
    <span class="c1"># Add the block of code to a temporary adm file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">adm_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">adm_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.adm&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_new</span><span class="p">:</span>
        <span class="n">insert_splines_here</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">insert_splines_here</span><span class="p">:</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;!----------------------------------- SPLINES ------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">code_block</span><span class="p">:</span>
                    <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">code_block</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;!----------------------------------- OUTPUT ------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">insert_splines_here</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="s1">&#39;!----------------------------------- OUTPUT ------------------------------------&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">insert_splines_here</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
    <span class="c1"># Replace the adm file with the temporary adm file </span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">adm_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">adm_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.adm&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">adm_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="add_splines_to_acf"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.add_splines_to_acf">[docs]</a><span class="k">def</span> <span class="nf">add_splines_to_acf</span><span class="p">(</span><span class="n">acf_file</span><span class="p">):</span>   
    <span class="sd">&quot;&quot;&quot;Adds spline references to the input variable function statements in an Adams Drill Command (.acf) file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    acf_file : str</span>
<span class="sd">        File name of an Adams Drill Command (.acf) file.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># go through original acf and create a new acf</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">acf_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">acf_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.acf&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid_new</span><span class="p">:</span>
        
        <span class="n">modify</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">variable_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
            <span class="c1"># For each line in the original acf file</span>

            <span class="k">if</span> <span class="n">modify</span><span class="p">:</span>
                <span class="c1"># If this is a line defining a drilling parameter</span>

                <span class="k">if</span> <span class="n">variable_id</span> <span class="o">==</span> <span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;gpm&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]:</span>
                    <span class="c1"># If the variable id is the gpm id</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39;, FUNCTION = STEP(TIME, 0,0,1,1)*VARVAL(11021)*ABS(AKISPL(TIME,0,</span><span class="si">{:d}</span><span class="s1">, 0))</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;gpm&#39;</span><span class="p">][</span><span class="s1">&#39;spline&#39;</span><span class="p">])</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">elif</span> <span class="n">variable_id</span> <span class="o">==</span> <span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;rop&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]:</span>
                    <span class="c1"># If the variable id is the rop id</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39;, FUNCTION = STEP(TIME, 0,0,1,1)*(AKISPL(TIME,0,</span><span class="si">{:d}</span><span class="s1">, 0))/3600</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;rop&#39;</span><span class="p">][</span><span class="s1">&#39;spline&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">variable_id</span> <span class="o">==</span> <span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;rpm&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]:</span>
                    <span class="c1"># If the variable id is the rpm id</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39;, FUNCTION = STEP(TIME, 0,0,1,1)*(AKISPL(TIME,0,</span><span class="si">{:d}</span><span class="s1">, 0))*(PI/30)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;rpm&#39;</span><span class="p">][</span><span class="s1">&#39;spline&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">variable_id</span> <span class="o">==</span> <span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;wob&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]:</span>
                    <span class="c1"># If the variable id is the wob id</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39;, FUNCTION = STEP(TIME, 0,0,1,1)*(AKISPL(TIME,0,</span><span class="si">{:d}</span><span class="s1">, 0))*1000</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ADRILL_IDS</span><span class="p">[</span><span class="s1">&#39;wob&#39;</span><span class="p">][</span><span class="s1">&#39;spline&#39;</span><span class="p">])</span>

                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
                <span class="n">modify</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">elif</span> <span class="n">skip</span><span class="p">:</span>
                <span class="c1"># If this is a line that should be skipped</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
                    <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                        
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If this is a normal line</span>
                <span class="n">fid_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;VARIABLE&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">variable_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">modify</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="c1"># Replace original acf file</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">acf_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">acf_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.acf&#39;</span><span class="p">,</span><span class="s1">&#39;.tmp&#39;</span><span class="p">),</span> <span class="n">acf_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="modify_acf_solver_settings"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.modify_acf_solver_settings">[docs]</a><span class="k">def</span> <span class="nf">modify_acf_solver_settings</span><span class="p">(</span><span class="n">acf_file</span><span class="p">,</span> <span class="n">statics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modifies the contents of the Adams Command (.acf) file given in `acf_file` to apply the static funnel given in `statics` and the dynamic steps given in `dynamics`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    acf_file : str</span>
<span class="sd">        Path to Adams Command (.acf) file to be updated</span>
<span class="sd">    statics : list</span>
<span class="sd">        List of six lists where each list contains the values of a particular equilibrium setting at each step in the funnel. (Defaults to the value already in the acf file.)</span>
<span class="sd">    error : float</span>
<span class="sd">        Error tolerance to use for the dynamics solver. (Defaults to the value already in the acf file.)</span>

<span class="sd">    Example</span>
<span class="sd">    -------    </span>
<span class="sd">    The following example modifies example.acf to have a three-step static funnel and a dynamic solver error tolerance of 0.0001.</span>

<span class="sd">    &gt;&gt;&gt; maxit = [500, 500, 500]</span>
<span class="sd">    &gt;&gt;&gt; stab = [8.0, 1.0, .01]</span>
<span class="sd">    &gt;&gt;&gt; error = [1.0, 0.1, .01]</span>
<span class="sd">    &gt;&gt;&gt; imbal = [4.0, 2.0, .01]</span>
<span class="sd">    &gt;&gt;&gt; tlim = [4.0, 2.0, 1.0]</span>
<span class="sd">    &gt;&gt;&gt; alim = [4.0, 2.0, 1.0] # Assumes DEGREES</span>
<span class="sd">    &gt;&gt;&gt; statics = [maxit, stab, error, imbal, tlim, alim]</span>
<span class="sd">    &gt;&gt;&gt; modify_acf_solver_settings(&#39;example.acf&#39;, statics=statics, error=.0001)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the current acf text</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">acf_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">acf_text</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="c1"># Replace the static funnel</span>
    <span class="k">if</span> <span class="n">statics</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">statics</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">statics</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">statics</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The statics list does not have the correct shape.&#39;</span><span class="p">)</span>

        <span class="c1"># Create the new funnel text</span>
        <span class="n">funnel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s1">&#39;equil/maxit=</span><span class="si">{maxit}</span><span class="s1">, stab=</span><span class="si">{stab}</span><span class="s1">, error=</span><span class="si">{error}</span><span class="s1">, imbal=</span><span class="si">{imbal}</span><span class="s1">, tlim=</span><span class="si">{tlim}</span><span class="s1">, alim=</span><span class="si">{alim}</span><span class="s1">D</span><span class="se">\n</span><span class="s1">sim/stat</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">maxit</span><span class="p">,</span> <span class="n">stab</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">imbal</span><span class="p">,</span> <span class="n">tlim</span><span class="p">,</span> <span class="n">alim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">statics</span><span class="p">)])</span>
        
        <span class="c1"># Replace the funnel</span>
        <span class="n">acf_text</span> <span class="o">=</span> <span class="n">ACF_FUNNEL_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;!</span><span class="se">\n</span><span class="s1">!</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">funnel</span><span class="p">,</span> <span class="n">acf_text</span><span class="p">)</span>
    
    <span class="c1"># Replace the dynamic error tolerance</span>
    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># current_integrator_block = re.match</span>
        <span class="n">error_text</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;, ERROR = </span><span class="si">{error}</span><span class="s1">&#39;</span>

        <span class="n">acf_text</span> <span class="o">=</span> <span class="n">ACF_INTEGRATOR_ERROR_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\1\2&#39;</span> <span class="o">+</span> <span class="n">error_text</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\4&#39;</span><span class="p">,</span> <span class="n">acf_text</span><span class="p">)</span>

    <span class="c1"># Write a temporary acf file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">acf_file</span> <span class="o">+</span> <span class="s1">&#39;._tmp_&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">acf_text</span><span class="p">)</span>
    
    <span class="c1"># Replace the existing acf file with the temporary</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">acf_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">acf_file</span> <span class="o">+</span> <span class="s1">&#39;._tmp_&#39;</span><span class="p">,</span> <span class="n">acf_file</span><span class="p">)</span>   </div>

<div class="viewcode-block" id="get_motor_curve"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_motor_curve">[docs]</a><span class="k">def</span> <span class="nf">get_motor_curve</span><span class="p">(</span><span class="n">stall_torque</span><span class="p">,</span> <span class="n">max_torque</span><span class="p">,</span> <span class="n">max_rpm</span><span class="p">,</span> <span class="n">min_rpm</span><span class="p">,</span> <span class="n">save_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;Returns data to generate a theoretical motor curve.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stall_torque : float</span>
<span class="sd">        Torque at which the motor stalls (klbf-ft)</span>
<span class="sd">    max_torque : float</span>
<span class="sd">        Maximum operating torque (klbf-ft)</span>
<span class="sd">    max_rpm : float</span>
<span class="sd">        Maximum operating motor speed</span>
<span class="sd">    min_rpm : float</span>
<span class="sd">        Minimum operating motor speed</span>
<span class="sd">    save_filename : bool, optional</span>
<span class="sd">        If True, motor curve will be saved to file `filename`, by default None</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Rpm points in normal operating range</span>
<span class="sd">    list</span>
<span class="sd">        Rpm points in extended stall range range</span>
<span class="sd">    list</span>
<span class="sd">        Torque points in normal operating range</span>
<span class="sd">    list</span>
<span class="sd">        Torque points in extended stall range range</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    This example plots the motor curve with a dashed line for the extended stall range.</span>
<span class="sd">    &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">    &gt;&gt;&gt; stall_torque = 20</span>
<span class="sd">    &gt;&gt;&gt; max_torque = 15</span>
<span class="sd">    &gt;&gt;&gt; max_rpm = 100</span>
<span class="sd">    &gt;&gt;&gt; min_rpm = 80</span>
<span class="sd">    &gt;&gt;&gt; nor_rpm, esr_rpm, nor_torque, esr_torque = get_motor_curve(stall_torque, max_torque, max_rpm, min_rpm)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot([rpm + min_rpm for rpm in nor_rpm], nor_torque)</span>
<span class="sd">    &gt;&gt;&gt; plt.plot(esr_rpm, esr_torque, linestyle=&#39;--&#39;)        </span>
<span class="sd">    &gt;&gt;&gt; plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">free_rpm</span> <span class="o">=</span> <span class="n">max_rpm</span> <span class="o">-</span> <span class="n">min_rpm</span>
    
    <span class="n">a_nor</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_torque</span><span class="o">/</span><span class="p">(</span><span class="n">free_rpm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b_nor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c_nor</span> <span class="o">=</span> <span class="n">max_torque</span>
    
    <span class="n">a_esr</span> <span class="o">=</span> <span class="p">(</span><span class="n">stall_torque</span> <span class="o">-</span> <span class="n">max_torque</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">min_rpm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">b_esr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">max_torque</span> <span class="o">-</span> <span class="n">stall_torque</span><span class="p">)</span><span class="o">/</span><span class="n">min_rpm</span>
    <span class="n">c_esr</span> <span class="o">=</span> <span class="n">stall_torque</span>    
    
    <span class="n">w_nor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">free_rpm</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w_esr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">min_rpm</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">q_nor</span> <span class="o">=</span> <span class="n">a_nor</span><span class="o">*</span><span class="n">w_nor</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b_nor</span><span class="o">*</span><span class="n">w_nor</span> <span class="o">+</span> <span class="n">c_nor</span>
    <span class="n">q_esr</span> <span class="o">=</span> <span class="n">a_esr</span><span class="o">*</span><span class="n">w_esr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b_esr</span><span class="o">*</span><span class="n">w_esr</span> <span class="o">+</span> <span class="n">c_esr</span>
        
    <span class="k">if</span> <span class="n">save_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RPM, Torque (klbf-ft)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">rpm</span><span class="p">,</span> <span class="n">torque</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">w_esr</span><span class="p">,</span> <span class="n">q_esr</span><span class="p">):</span>
                <span class="c1"># For each rpm and torque datapoin in the extended stall range, write the data point</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpm</span><span class="p">,</span> <span class="n">torque</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">rpm</span><span class="p">,</span> <span class="n">torque</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">w_nor</span><span class="p">,</span> <span class="n">q_nor</span><span class="p">):</span>
                <span class="c1"># For each rpm and torque datapoin in the normal operating range, write the data point and shift the rpm value by the rpm at max torque</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpm</span><span class="o">+</span><span class="n">min_rpm</span><span class="p">,</span> <span class="n">torque</span><span class="p">))</span>   

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">w_nor</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">w_esr</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">q_nor</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">q_esr</span><span class="p">)</span>    </div>
    
<div class="viewcode-block" id="get_motor_coefficients"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.get_motor_coefficients">[docs]</a><span class="k">def</span> <span class="nf">get_motor_coefficients</span><span class="p">(</span><span class="n">min_rpms</span><span class="p">,</span> <span class="n">max_rpms</span><span class="p">,</span> <span class="n">flows</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the motor coefficients used in the Adams Drill motor model.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    min_rpms : list</span>
<span class="sd">        List of the minimum operating motor speeds for each flow rate.</span>
<span class="sd">    max_rpms : list</span>
<span class="sd">        List of the maximum operating motor speeds for each flow rate.</span>
<span class="sd">    flows : list</span>
<span class="sd">        List of corresponding flow rates</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        NOR Max (No Load) RPM A</span>
<span class="sd">    float</span>
<span class="sd">        NOR Max (No Load) RPM B</span>
<span class="sd">    float</span>
<span class="sd">        NOR Min (Max dP) RPM A</span>
<span class="sd">    float</span>
<span class="sd">        NOR Min (Max dP) RPM A</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="n">nor_min_rpm_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">flows</span><span class="p">,</span> <span class="n">min_rpms</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span><span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="n">nor_max_rpm_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">flows</span><span class="p">,</span> <span class="n">max_rpms</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="n">nor_max_rpm_b</span><span class="p">,</span> <span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="n">nor_min_rpm_b</span></div>

<div class="viewcode-block" id="MotorModel"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModel">[docs]</a><span class="k">class</span> <span class="nc">MotorModel</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_rpms</span><span class="p">,</span> <span class="n">max_rpms</span><span class="p">,</span> <span class="n">flows</span><span class="p">,</span> <span class="n">stall_torque</span><span class="p">,</span> <span class="n">max_torque</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes an Adams Motor Model</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_rpms : list</span>
<span class="sd">            List of the minimum operating motor speeds for each flow rate.</span>
<span class="sd">        max_rpms : list</span>
<span class="sd">            List of the maximum operating motor speeds for each flow rate.</span>
<span class="sd">        flows : list</span>
<span class="sd">            List of corresponding flow rates</span>
<span class="sd">        stall_torque : float</span>
<span class="sd">            Torque at which the motor stalls (klbf-ft)</span>
<span class="sd">        max_torque : float</span>
<span class="sd">            Maximum operating torque (klbf-ft)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="n">nor_max_rpm_b</span><span class="p">,</span> <span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="n">nor_min_rpm_b</span> <span class="o">=</span> <span class="n">get_motor_coefficients</span><span class="p">(</span><span class="n">min_rpms</span><span class="p">,</span> <span class="n">max_rpms</span><span class="p">,</span> <span class="n">flows</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_a</span> <span class="o">=</span> <span class="n">nor_max_rpm_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_b</span> <span class="o">=</span> <span class="n">nor_max_rpm_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_a</span> <span class="o">=</span> <span class="n">nor_min_rpm_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_b</span> <span class="o">=</span> <span class="n">nor_min_rpm_b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_torque</span> <span class="o">=</span> <span class="n">max_torque</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stall_torque</span> <span class="o">=</span> <span class="n">stall_torque</span>
    
<div class="viewcode-block" id="MotorModel.degrade_motor"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModel.degrade_motor">[docs]</a>    <span class="k">def</span> <span class="nf">degrade_motor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degradation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Degrades the motor by `degradation` (in place)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        degradation : float</span>
<span class="sd">            Motor degradation factor</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_a</span> <span class="o">*=</span> <span class="n">degradation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_b</span> <span class="o">*=</span> <span class="n">degradation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_a</span> <span class="o">*=</span> <span class="n">degradation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_b</span> <span class="o">*=</span> <span class="n">degradation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_torque</span> <span class="o">*=</span> <span class="n">degradation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stall_torque</span> <span class="o">*=</span> <span class="n">degradation</span></div>

<div class="viewcode-block" id="MotorModel.get_torque"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModel.get_torque">[docs]</a>    <span class="k">def</span> <span class="nf">get_torque</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpm</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">degradation</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the motor output torque given a motor rpm and flow rate.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rpm : float</span>
<span class="sd">            Motor rpm</span>
<span class="sd">        flow : float</span>
<span class="sd">            Motor flow rate</span>
<span class="sd">        degradation : float</span>
<span class="sd">            Motor degradation factor (default is 1 which means there is no degradation)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Motor output torque</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        MotorModelError</span>
<span class="sd">            Raised if the rpm given is greater than the motors maximum output rpm.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nor_min_rpm_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_a</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">nor_min_rpm_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_b</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">nor_max_rpm_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_a</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">nor_max_rpm_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_b</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">max_torque</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_torque</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">stall_torque</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stall_torque</span><span class="o">*</span><span class="n">degradation</span>
        

        <span class="n">min_rpm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="n">nor_min_rpm_b</span><span class="p">],</span> <span class="n">flow</span><span class="p">)</span><span class="o">*</span><span class="n">degradation</span>
        <span class="n">max_rpm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="n">nor_max_rpm_b</span><span class="p">],</span> <span class="n">flow</span><span class="p">)</span><span class="o">*</span><span class="n">degradation</span>

        <span class="n">free_rpm</span> <span class="o">=</span> <span class="n">max_rpm</span> <span class="o">-</span> <span class="n">min_rpm</span>
        
        <span class="k">if</span> <span class="n">rpm</span> <span class="o">&lt;</span> <span class="n">min_rpm</span><span class="p">:</span>
            <span class="n">a_coef</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_torque</span><span class="o">/</span><span class="p">(</span><span class="n">free_rpm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">b_coef</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">c_coef</span> <span class="o">=</span> <span class="n">max_torque</span>
        
        <span class="k">elif</span> <span class="n">rpm</span> <span class="o">&gt;</span> <span class="n">max_rpm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MotorModelError</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;The rpm provided is greater than the max rpm of </span><span class="si">{max_rpm}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">a_coef</span> <span class="o">=</span> <span class="p">(</span><span class="n">stall_torque</span> <span class="o">-</span> <span class="n">max_torque</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">min_rpm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">b_coef</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">max_torque</span> <span class="o">-</span> <span class="n">stall_torque</span><span class="p">)</span><span class="o">/</span><span class="n">min_rpm</span>
            <span class="n">c_coef</span> <span class="o">=</span> <span class="n">stall_torque</span>            
        
        <span class="k">return</span> <span class="n">a_coef</span><span class="o">*</span><span class="n">rpm</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b_coef</span><span class="o">*</span><span class="n">rpm</span> <span class="o">+</span> <span class="n">c_coef</span></div>
    
<div class="viewcode-block" id="MotorModel.get_motor_curve"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModel.get_motor_curve">[docs]</a>    <span class="k">def</span> <span class="nf">get_motor_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns data t`o generate a theoretical motor curve.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flow : float</span>
<span class="sd">            Flow rate at which to generate the motor curve</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Rpm points in normal operating range</span>
<span class="sd">        list</span>
<span class="sd">            Rpm points in extended stall range range</span>
<span class="sd">        list</span>
<span class="sd">            Torque points in normal operating range</span>
<span class="sd">        list</span>
<span class="sd">            Torque points in extended stall range range</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        This example plots the motor curve with a dashed line for the extended stall range.</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; stall_torque = 20</span>
<span class="sd">        &gt;&gt;&gt; max_torque = 15</span>
<span class="sd">        &gt;&gt;&gt; max_rpms = [80, 100, 120]</span>
<span class="sd">        &gt;&gt;&gt; min_rpm = [50, 70, 90]</span>
<span class="sd">        &gt;&gt;&gt; flows = [400, 500, 600]</span>
<span class="sd">        &gt;&gt;&gt; motor_model = MotorModel(min_rpms, max_rpms, flows, stall_torque, max_torque)</span>
<span class="sd">        &gt;&gt;&gt; nor_rpm, esr_rpm, nor_torque, esr_torque = motor_model.get_motor_curve(550)</span>
<span class="sd">        &gt;&gt;&gt; plt.plot([rpm + min_rpm for rpm in nor_rpm], nor_torque)</span>
<span class="sd">        &gt;&gt;&gt; plt.plot(esr_rpm, esr_torque, linestyle=&#39;--&#39;)        </span>
<span class="sd">        &gt;&gt;&gt; plt.show()</span>

<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="n">min_rpm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_min_rpm_b</span><span class="p">],</span> <span class="n">flow</span><span class="p">)</span>
        <span class="n">max_rpm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nor_max_rpm_b</span><span class="p">],</span> <span class="n">flow</span><span class="p">)</span>

        <span class="n">nor_rpm</span><span class="p">,</span> <span class="n">esr_rpm</span><span class="p">,</span> <span class="n">nor_torque</span><span class="p">,</span> <span class="n">esr_torque</span> <span class="o">=</span>  <span class="n">get_motor_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stall_torque</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_torque</span><span class="p">,</span> <span class="n">max_rpm</span><span class="p">,</span> <span class="n">min_rpm</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">min_rpm</span><span class="p">,</span> <span class="n">max_rpm</span><span class="p">,</span> <span class="n">nor_rpm</span><span class="p">,</span> <span class="n">esr_rpm</span><span class="p">,</span> <span class="n">nor_torque</span><span class="p">,</span> <span class="n">esr_torque</span></div>

<div class="viewcode-block" id="MotorModel.build_from_coeffs"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModel.build_from_coeffs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">build_from_coeffs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nor_max_rpm_a</span><span class="p">,</span> <span class="n">nor_max_rpm_b</span><span class="p">,</span> <span class="n">nor_min_rpm_a</span><span class="p">,</span> <span class="n">nor_min_rpm_b</span><span class="p">,</span> <span class="n">max_torque</span><span class="p">,</span> <span class="n">stall_torque</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Used to build a motor model if you already know the motor coefficients.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nor_max_rpm_a : float</span>
<span class="sd">            nor_max_rpm_a</span>
<span class="sd">        nor_max_rpm_b : float</span>
<span class="sd">            nor_max_rpm_b</span>
<span class="sd">        nor_min_rpm_a : float</span>
<span class="sd">            nor_min_rpm_a</span>
<span class="sd">        nor_min_rpm_b : float</span>
<span class="sd">            nor_min_rpm_b</span>
<span class="sd">        max_torque : float</span>
<span class="sd">            max_torque</span>
<span class="sd">        stall_torque : float</span>
<span class="sd">            stall_torque</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MotorModel</span>
<span class="sd">            A :obj:`MotorModel` object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">motor_model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">stall_torque</span><span class="p">,</span> <span class="n">max_torque</span><span class="p">)</span>
        <span class="n">motor_model</span><span class="o">.</span><span class="n">nor_max_rpm_a</span> <span class="o">=</span> <span class="n">nor_max_rpm_a</span>
        <span class="n">motor_model</span><span class="o">.</span><span class="n">nor_max_rpm_b</span> <span class="o">=</span> <span class="n">nor_max_rpm_b</span>
        <span class="n">motor_model</span><span class="o">.</span><span class="n">nor_min_rpm_a</span> <span class="o">=</span> <span class="n">nor_min_rpm_a</span>
        <span class="n">motor_model</span><span class="o">.</span><span class="n">nor_min_rpm_b</span> <span class="o">=</span> <span class="n">nor_min_rpm_b</span>
        <span class="k">return</span> <span class="n">motor_model</span></div></div>

<div class="viewcode-block" id="MotorModelError"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.MotorModelError">[docs]</a><span class="k">class</span> <span class="nc">MotorModelError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="TiemOrbitSyntaxError"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.TiemOrbitSyntaxError">[docs]</a><span class="k">class</span> <span class="nc">TiemOrbitSyntaxError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<div class="viewcode-block" id="cdbError"><a class="viewcode-back" href="../../../adamspy.adripy.html#adamspy.adripy.utilities.cdbError">[docs]</a><span class="k">class</span> <span class="nc">cdbError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Ben Thornton

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>